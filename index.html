<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Simulador de Tests</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        margin: 0;
        padding: 1rem;
        background: #f5f5f5;
        color: #222;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: #fff;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      }
      h1 {
        margin-top: 0;
        font-size: 1.6rem;
      }
      select,
      button {
        font-size: 1rem;
        padding: 0.4rem 0.6rem;
        margin-top: 0.5rem;
      }
      button {
        cursor: pointer;
      }
      .hidden {
        display: none;
      }
      .question {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #ddd;
      }
      .options {
        margin-top: 0.5rem;
      }
      .option {
        margin-bottom: 0.25rem;
      }
      .result {
        margin-top: 1rem;
        padding: 0.75rem;
        border-radius: 6px;
        background: #eef6ff;
      }
      .summary {
        margin-top: 1.5rem;
        padding: 1rem;
        border-radius: 6px;
        background: #f0fdf4;
        border: 1px solid #86efac;
      }
      .incorrect {
        color: #b91c1c;
        font-weight: 600;
      }
      .correct {
        color: #166534;
        font-weight: 600;
      }
      .small {
        font-size: 0.9rem;
        color: #555;
      }
      label {
        font-weight: 500;
      }
      input[type="number"] {
        width: 4rem;
        padding: 0.2rem 0.3rem;
        font-size: 1rem;
        margin-left: 0.25rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Simulador de Tests</h1>
      <p class="small">
        Banco de preguntas cargado desde <code>preguntas.json</code>. Elige un
        módulo y realiza un test de hasta 30 preguntas tipo test.
      </p>

      <div id="config">
        <div>
          <label for="modulo">Módulo:</label>
          <select id="modulo"></select>
        </div>
        <div style="margin-top: 0.5rem">
          <label for="numPreguntas">
            Número de preguntas (máx. 30):
          </label>
          <input
            type="number"
            id="numPreguntas"
            min="1"
            max="30"
            value="30"
          />
        </div>
        <button id="btnComenzar">Comenzar examen</button>
      </div>

      <div id="examen" class="hidden">
        <div id="progreso" class="small"></div>
        <div id="preguntaActual" class="question"></div>
        <div id="resultadoPregunta" class="result hidden"></div>
        <button id="btnSiguiente" class="hidden">Siguiente pregunta</button>
      </div>

      <div id="resumen" class="summary hidden"></div>
    </div>

    <script>
      const PREGUNTAS_MAX = 30;
      let banco = {};
      let moduloActual = "";
      let preguntasSeleccionadas = [];
      let indicePregunta = 0;
      let aciertos = 0;

      async function cargarBanco() {
        try {
          const resp = await fetch("preguntas.json");
          if (!resp.ok) throw new Error("No se pudo cargar preguntas.json");
          banco = await resp.json();
          poblarModulos();
        } catch (e) {
          alert(
            "Error cargando el banco de preguntas. Asegúrate de que preguntas.json está junto a este HTML."
          );
          console.error(e);
        }
      }

      function poblarModulos() {
        const sel = document.getElementById("modulo");
        sel.innerHTML = "";
        Object.keys(banco).forEach((nombre) => {
          const opt = document.createElement("option");
          opt.value = nombre;
          opt.textContent = nombre;
          sel.appendChild(opt);
        });
      }

      function mezclar(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      function comenzarExamen() {
        moduloActual = document.getElementById("modulo").value;
        const numDeseado = parseInt(
          document.getElementById("numPreguntas").value,
          10
        );
        const bancoModulo = banco[moduloActual] || [];
        if (bancoModulo.length === 0) {
          alert("No hay preguntas para este módulo.");
          return;
        }

        let n = Math.min(
          Math.max(1, isNaN(numDeseado) ? PREGUNTAS_MAX : numDeseado),
          PREGUNTAS_MAX,
          bancoModulo.length
        );

        const indices = [...bancoModulo.keys()];
        mezclar(indices);
        preguntasSeleccionadas = indices.slice(0, n).map((i) => bancoModulo[i]);
        aciertos = 0;
        indicePregunta = 0;

        document.getElementById("config").classList.add("hidden");
        document.getElementById("examen").classList.remove("hidden");
        document.getElementById("resumen").classList.add("hidden");

        mostrarPregunta();
      }

      function mostrarPregunta() {
        const total = preguntasSeleccionadas.length;
        const actual = preguntasSeleccionadas[indicePregunta];
        const cont = document.getElementById("preguntaActual");
        const progreso = document.getElementById("progreso");
        const resultadoPregunta = document.getElementById("resultadoPregunta");
        const btnSiguiente = document.getElementById("btnSiguiente");

        progreso.textContent = `Pregunta ${
          indicePregunta + 1
        } de ${total} · Módulo: ${moduloActual}`;

        const opcionesMezcladas = mezclar(
          actual.opciones.map((o, idx) => ({ ...o, idx }))
        );

        cont.innerHTML = "";
        const enunciado = document.createElement("div");
        enunciado.textContent = actual.texto;
        cont.appendChild(enunciado);

        const opcionesDiv = document.createElement("div");
        opcionesDiv.className = "options";
        const letras = ["A", "B", "C", "D"];
        opcionesMezcladas.forEach((op, i) => {
          const label = document.createElement("label");
          label.className = "option";
          const input = document.createElement("input");
          input.type = "radio";
          input.name = "opcion";
          input.value = i;
          label.appendChild(input);
          label.append(` ${letras[i]}. ${op.texto}`);
          opcionesDiv.appendChild(label);
        });
        cont.appendChild(opcionesDiv);

        resultadoPregunta.classList.add("hidden");
        resultadoPregunta.innerHTML = "";
        btnSiguiente.classList.add("hidden");

        cont.onclick = (e) => {
          if (e.target && e.target.name === "opcion") {
            corregirPregunta(opcionesMezcladas, parseInt(e.target.value, 10));
          }
        };
      }

      function corregirPregunta(opciones, indiceElegido) {
        const resultadoPregunta = document.getElementById("resultadoPregunta");
        const btnSiguiente = document.getElementById("btnSiguiente");

        const elegida = opciones[indiceElegido];
        const esCorrecta = !!elegida.correcta;

        resultadoPregunta.classList.remove("hidden");
        resultadoPregunta.innerHTML = "";

        const p = document.createElement("p");
        if (esCorrecta) {
          p.innerHTML = '<span class="correct">Correcto.</span>';
          aciertos += 1;
        } else {
          p.innerHTML = '<span class="incorrect">Incorrecto.</span>';
          const correcta = opciones.find((o) => o.correcta);
          if (correcta) {
            p.innerHTML += "<br/>La respuesta correcta era: " + correcta.texto;
          }
        }
        resultadoPregunta.appendChild(p);

        btnSiguiente.classList.remove("hidden");
      }

      function siguientePregunta() {
        indicePregunta += 1;
        if (indicePregunta >= preguntasSeleccionadas.length) {
          terminarExamen();
        } else {
          mostrarPregunta();
        }
      }

      function terminarExamen() {
        document.getElementById("examen").classList.add("hidden");
        const resumenDiv = document.getElementById("resumen");
        resumenDiv.classList.remove("hidden");

        const total = preguntasSeleccionadas.length;
        const nota = (aciertos / total) * 10;
        const haAprobadoOficial =
          total >= 30 && aciertos >= 18 ? "Sí" : "No (criterio oficial 18/30)";
        const haAprobado60 = aciertos >= total * 0.6 ? "Sí" : "No";

        resumenDiv.innerHTML = `
          <h2>Resultados</h2>
          <p>Aciertos: <strong>${aciertos}</strong> de <strong>${total}</strong></p>
          <p>Nota aproximada (sobre 10): <strong>${nota.toFixed(2)}</strong></p>
          <p>¿Aprueba según criterio oficial (18/30)? <strong>${haAprobadoOficial}</strong></p>
          <p>¿Aprueba con criterio 60% aciertos? <strong>${haAprobado60}</strong></p>
          <button id="btnRepetir">Volver a empezar</button>
        `;

        document.getElementById("btnRepetir").onclick = () => {
          document.getElementById("config").classList.remove("hidden");
          resumenDiv.classList.add("hidden");
        };
      }

      document.getElementById("btnComenzar").addEventListener("click", comenzarExamen);
      document.getElementById("btnSiguiente").addEventListener("click", siguientePregunta);

      cargarBanco();
    </script>
  </body>
  </html>

